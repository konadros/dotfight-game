<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dot Fight - Version 9.2</title>
    <style>
        :root {
            --board-width: 300px; --board-height: 500px; --dot-size: 40px; --pawn-size: 32px;
            --red-color: #c0392b; --blue-color: #2980b9; --highlight-color: #f1c40f; --move-color: #27ae60;
            --bg-color: #2c3e50; --text-color: #ecf0f1; --dot-color: #7f8c8d; --line-color: #95a5a6;
            --container-bg: #34495e; --danger-color: #e74c3c;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex;
            justify-content: center; align-items: center; height: 100vh; margin: 0;
            background-color: var(--bg-color); color: var(--text-color);
        }
        .hidden { display: none !important; }
        .menu { text-align: center; }
        .menu h1 { font-size: 3.5em; margin-bottom: 40px; color: var(--highlight-color); }
        .menu-button {
            display: block; width: 250px; padding: 15px; font-size: 1.2em;
            margin: 15px auto; cursor: pointer; border: 2px solid var(--line-color);
            border-radius: 8px; background-color: transparent; color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .menu-button:hover { background-color: var(--highlight-color); color: var(--bg-color); border-color: var(--highlight-color); }
        .options-group { margin: 30px 0; }
        .option-button {
            display: inline-block; padding: 10px 20px; font-size: 1em; margin: 5px;
            cursor: pointer; border: 2px solid var(--line-color); border-radius: 5px;
            background-color: var(--container-bg); color: var(--text-color);
        }
        .option-button.selected { background-color: var(--blue-color); border-color: var(--blue-color); }
        .game-wrapper {
            background-color: var(--container-bg); padding: 20px; border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); width: var(--board-width);
            transition: width 0.5s ease-in-out;
        }
        .game-wrapper.rotated-mode { width: var(--board-height); }
        .hud { margin-bottom: 20px; height: 60px; text-align: center; }
        #turn-indicator { font-size: 2em; font-weight: bold; }
        #game-mode-indicator { font-size: 0.9em; color: #bdc3c7; margin-top: 5px;}
        #board-container {
            position: relative; width: var(--board-width); height: var(--board-height);
            transition: transform 0.5s ease-in-out; margin: 0 auto;
        }
        #board-container.rotated { transform: rotate(90deg); }
        .line { position: absolute; background-color: var(--line-color); transform-origin: 0 0; height: 2px;}
        .dot {
            position: absolute; width: var(--dot-size); height: var(--dot-size);
            background-color: var(--dot-color); border-radius: 50%; cursor: pointer;
            transform: translate(-50%, -50%); display: flex;
            justify-content: center; align-items: center; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .pawn { width: var(--pawn-size); height: var(--pawn-size); border-radius: 50%; pointer-events: none; }
        .red-pawn { background-color: var(--red-color); }
        .blue-pawn { background-color: var(--blue-color); }
        .selected { box-shadow: 0 0 15px 5px var(--highlight-color); }
        .possible-move { background-color: var(--move-color); }
        .controls { margin-top: 20px; text-align: center; }
        .game-button {
            padding: 10px 20px; font-size: 1em; cursor: pointer; border: none;
            border-radius: 5px; background-color: #555; color: var(--text-color); margin: 0 5px;
        }
    </style>
</head>
<body>

<div id="main-menu" class="menu">
    <h1>Dot Fight</h1>
    <button id="p-vs-p-btn" class="menu-button">Player vs. Player</button>
    <button id="p-vs-ai-btn" class="menu-button">Player vs. AI</button>
</div>

<div id="settings-screen" class="menu hidden">
    <h1>Settings</h1>
    <div id="ai-difficulty-group" class="options-group hidden">
        <h2>AI Skill</h2>
        <button class="option-button selected" data-ai-skill="Easy">Easy</button>
        <button class="option-button" data-ai-skill="Medium">Medium</button>
    </div>
    <div class="options-group">
        <h2>Rules</h2>
        <button class="option-button selected" data-difficulty="Beginner">Beginner</button>
        <button class="option-button" data-difficulty="Intermediate">Intermediate</button>
        <button class="option-button" data-difficulty="Expert">Expert</button>
    </div>
    <button id="start-game-btn" class="menu-button">Start Game</button>
</div>

<div class="game-wrapper hidden">
    <div class="hud">
        <div id="turn-indicator">Red's Turn</div>
        <div id="game-mode-indicator"></div>
    </div>
    <div id="board-container"></div>
    <div class="controls">
        <button id="new-game-btn" class="game-button">Reset</button>
        <button id="rotate-btn" class="game-button">Rotate</button>
        <button id="back-to-menu-btn" class="game-button">Menu</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const boardData = {
            dots: { 1:{x:50,y:50}, 2:{x:150,y:50}, 3:{x:250,y:50}, 4:{x:150,y:150}, 5:{x:250,y:150}, 6:{x:150,y:250}, 7:{x:150,y:350}, 8:{x:50,y:350}, 9:{x:150,y:450}, 10:{x:50,y:450}, 11:{x:250,y:450} },
            adjacencies: { 1:[2], 2:[1,3,4], 3:[2], 4:[2,5,6], 5:[4], 6:[4,7], 7:[6,8,9], 8:[7], 9:[7,10,11], 10:[9], 11:[9] },
            captureLines: [ [1,2,3], [10,9,11], [2,4,6,7,9] ]
        };
        
        let state = {
            pawns: {},
            currentTurn: 'Red',
            mode: 'HvAI',
            aiSkill: 'Medium',
            difficulty: 'Beginner',
            selectedId: null,
            mustCaptureId: null,
            history: [],
            winner: null
        };

        const mainMenu = document.getElementById('main-menu');
        const settingsScreen = document.getElementById('settings-screen');
        const gameWrapper = document.querySelector('.game-wrapper');
        const boardContainer = document.getElementById('board-container');

        // --- CORE LOGIC ---
        function initGame() {
            state.pawns = {
                'r1':{id:'r1', player:'Red', pos:10}, 'r2':{id:'r2', player:'Red', pos:9}, 'r3':{id:'r3', player:'Red', pos:11},
                'b1':{id:'b1', player:'Blue', pos:1}, 'b2':{id:'b2', player:'Blue', pos:2}, 'b3':{id:'b3', player:'Blue', pos:3}
            };
            state.currentTurn = 'Red';
            state.winner = null;
            state.selectedId = null;
            state.mustCaptureId = null;
            state.history = [];
            
            renderBoard();
            updateHUD();
        }

        function switchTurn() {
            if (state.winner) return;
            state.currentTurn = (state.currentTurn === 'Red') ? 'Blue' : 'Red';
            state.selectedId = null;
            state.mustCaptureId = null;
            updateHUD();
            
            if (state.mode === 'HvAI' && state.currentTurn === 'Blue') {
                console.log("AI Triggered...");
                setTimeout(runAILogic, 600);
            }
        }

        function executeMove(pawnId, toPos, isCapture, capturedPos) {
            const pawn = state.pawns[pawnId];
            pawn.pos = toPos;
            
            if (isCapture) {
                const victim = Object.values(state.pawns).find(p => p.pos === capturedPos);
                if (victim) delete state.pawns[victim.id];
                
                const nextCaps = getCaptures(pawnId, state.pawns);
                if (nextCaps.length > 0) {
                    state.mustCaptureId = pawnId;
                    renderBoard();
                    if (state.mode === 'HvAI' && state.currentTurn === 'Blue') setTimeout(runAILogic, 600);
                    return;
                }
            }
            
            renderBoard();
            if (!checkWin()) switchTurn();
        }

        // --- AI ENGINE ---
        function runAILogic() {
            if (state.winner || state.currentTurn !== 'Blue') return;

            let moves = [];
            const aiPawns = Object.values(state.pawns).filter(p => p.player === 'Blue');
            
            aiPawns.forEach(p => {
                const pMoves = getAllLegalMoves(p.id, state.pawns);
                pMoves.forEach(m => moves.push({pawnId: p.id, ...m}));
            });

            if (moves.length === 0) {
                console.log("AI has no moves.");
                return;
            }

            const caps = moves.filter(m => m.isCapture);
            if (caps.length > 0) {
                const choice = caps[0];
                executeMove(choice.pawnId, choice.to, true, choice.capturedPos);
                return;
            }

            if (state.aiSkill === 'Easy') {
                const choice = moves[Math.floor(Math.random() * moves.length)];
                executeMove(choice.pawnId, choice.to, false);
            } else {
                const safeMoves = moves.filter(m => isMoveSafe(m.pawnId, m.to));
                const choice = safeMoves.length > 0 ? safeMoves[0] : moves[0];
                executeMove(choice.pawnId, choice.to, false);
            }
        }

        function isMoveSafe(pawnId, toPos) {
            const mockPawns = JSON.parse(JSON.stringify(state.pawns));
            mockPawns[pawnId].pos = toPos;
            const reds = Object.values(mockPawns).filter(p => p.player === 'Red');
            for (let r of reds) {
                if (getCaptures(r.id, mockPawns).length > 0) return false;
            }
            return true;
        }

        // --- UTILS ---
        function getAllLegalMoves(pawnId, pawnSet) {
            const caps = getCaptures(pawnId, pawnSet);
            if (caps.length > 0) return caps;
            if (state.mustCaptureId && state.mustCaptureId !== pawnId) return [];
            return getSimples(pawnId, pawnSet);
        }

        function getCaptures(pawnId, pawnSet) {
            const p = pawnSet[pawnId];
            const opp = (p.player === 'Red') ? 'Blue' : 'Red';
            const results = [];
            boardData.captureLines.forEach(line => {
                const idx = line.indexOf(p.pos);
                if (idx === -1) return;
                [-1, 1].forEach(dir => {
                    const mid = line[idx + dir];
                    const end = line[idx + dir * 2];
                    if (end !== undefined) {
                        const midPawn = Object.values(pawnSet).find(pawn => pawn.pos === mid);
                        const endPawn = Object.values(pawnSet).find(pawn => pawn.pos === end);
                        if (midPawn && midPawn.player === opp && !endPawn) {
                            results.push({to: end, isCapture: true, capturedPos: mid});
                        }
                    }
                });
            });
            return results;
        }

        function getSimples(pawnId, pawnSet) {
            const p = pawnSet[pawnId];
            const results = [];
            const adj = boardData.adjacencies[p.pos] || [];
            adj.forEach(target => {
                const occupied = Object.values(pawnSet).find(pawn => pawn.pos === target);
                if (!occupied) results.push({to: target, isCapture: false});
            });
            return results;
        }

        function checkWin() {
            const counts = { Red: 0, Blue: 0 };
            Object.values(state.pawns).forEach(p => counts[p.player]++);
            if (counts.Red === 0) state.winner = 'Blue';
            if (counts.Blue === 0) state.winner = 'Red';
            if (state.winner) {
                document.getElementById('turn-indicator').innerText = state.winner + " Wins!";
                return true;
            }
            return false;
        }

        // --- UI RENDER ---
        function renderBoard() {
            boardContainer.innerHTML = '';
            // Draw lines
            const drawn = new Set();
            for (let startNode in boardData.adjacencies) {
                boardData.adjacencies[startNode].forEach(endNode => {
                    const key = [startNode, endNode].sort().join('-');
                    if (!drawn.has(key)) {
                        const p1 = boardData.dots[startNode], p2 = boardData.dots[endNode];
                        const line = document.createElement('div');
                        line.className = 'line';
                        const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
                        const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                        line.style.width = dist + "px";
                        line.style.left = p1.x + "px";
                        line.style.top = p1.y + "px";
                        line.style.transform = `rotate(${angle}rad)`;
                        boardContainer.appendChild(line);
                        drawn.add(key);
                    }
                });
            }
            // Draw Dots
            for (let id in boardData.dots) {
                const d = boardData.dots[id];
                const dotEl = document.createElement('div');
                dotEl.className = 'dot';
                dotEl.style.left = d.x + 'px';
                dotEl.style.top = d.y + 'px';
                dotEl.onclick = () => onDotClick(parseInt(id));
                
                const pawn = Object.values(state.pawns).find(p => p.pos === parseInt(id));
                if (pawn) {
                    const pEl = document.createElement('div');
                    pEl.className = `pawn ${pawn.player.toLowerCase()}-pawn`;
                    if (state.selectedId === pawn.id) pEl.classList.add('selected');
                    dotEl.appendChild(pEl);
                }
                
                if (state.selectedId) {
                    const possible = getAllLegalMoves(state.selectedId, state.pawns);
                    if (possible.find(m => m.to === parseInt(id))) dotEl.classList.add('possible-move');
                }
                
                boardContainer.appendChild(dotEl);
            }
        }

        function onDotClick(id) {
            if (state.winner) return;
            if (state.mode === 'HvAI' && state.currentTurn === 'Blue') return;

            const clickedPawn = Object.values(state.pawns).find(p => p.pos === id);
            
            if (state.selectedId) {
                const moves = getAllLegalMoves(state.selectedId, state.pawns);
                const move = moves.find(m => m.to === id);
                if (move) {
                    executeMove(state.selectedId, id, move.isCapture, move.capturedPos);
                    return;
                }
            }

            if (clickedPawn && clickedPawn.player === state.currentTurn) {
                if (state.mustCaptureId && state.mustCaptureId !== clickedPawn.id) return;
                state.selectedId = clickedPawn.id;
                renderBoard();
            }
        }

        function updateHUD() {
            const indicator = document.getElementById('turn-indicator');
            indicator.innerText = state.currentTurn + "'s Turn";
            indicator.style.color = (state.currentTurn === 'Red') ? 'var(--red-color)' : 'var(--blue-color)';
        }

        // --- MENU EVENTS ---
        document.getElementById('p-vs-p-btn').onclick = () => showSettings('HvH');
        document.getElementById('p-vs-ai-btn').onclick = () => showSettings('HvAI');
        document.getElementById('start-game-btn').onclick = () => {
            settingsScreen.classList.add('hidden');
            gameWrapper.classList.remove('hidden');
            initGame();
        };
        document.getElementById('rotate-btn').onclick = () => {
            boardContainer.classList.toggle('rotated');
        };
        document.getElementById('back-to-menu-btn').onclick = () => {
            gameWrapper.classList.add('hidden');
            mainMenu.classList.remove('hidden');
        };
        document.getElementById('new-game-btn').onclick = initGame;

        function showSettings(mode) {
            state.mode = mode;
            mainMenu.classList.add('hidden');
            settingsScreen.classList.remove('hidden');
            document.getElementById('ai-difficulty-group').classList.toggle('hidden', mode === 'HvH');
        }

        settingsScreen.addEventListener('click', e => {
            if (e.target.dataset.aiSkill) {
                state.aiSkill = e.target.dataset.aiSkill;
                document.querySelectorAll('[data-ai-skill]').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
            }
            if (e.target.dataset.difficulty) {
                state.difficulty = e.target.dataset.difficulty;
                document.querySelectorAll('[data-difficulty]').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        const modeText = (state.mode === 'HvAI') ? "Player vs AI" : "Local PvP";
        document.getElementById('game-mode-indicator').innerText = modeText;
    });
</script>
</body>
</html>
